#!/bin/bash

set -e

# Status helper function
status() {
    if [ $? -eq 0 ]; then
        echo "âœ… $1"
    else
        echo "âŒ $1"
        return 1
    fi
}

echo "Running pre-commit hook: Vale prose linting..."

# Check if Vale is available
if ! command -v vale &> /dev/null; then
    echo "âŒ Vale command not found. Please install it first."
    exit 1
fi

# Check if Vale config exists
if [ ! -f ".vale.ini" ] && [ ! -f "_vale.ini" ] && [ ! -f "vale.ini" ]; then
    echo "âš ï¸  No Vale configuration found. Creating a basic .vale.ini file..."
    cat > .vale.ini << 'EOF'
# Vale configuration file
# See https://vale.sh/docs/topics/config/ for more options

StylesPath = .vale/styles

MinAlertLevel = suggestion

# Packages to install with 'vale sync'
Packages = Microsoft, write-good

# Global settings
[*]
# Basic Vale rules that work without external packages
BasedOnStyles = Vale

# Markdown-specific settings
[*.md]
BasedOnStyles = Vale, Microsoft, write-good

# Text files
[*.txt]
BasedOnStyles = Vale, Microsoft, write-good

# RestructuredText
[*.rst]
BasedOnStyles = Vale, Microsoft, write-good
EOF
    echo "ðŸ“ Created .vale.ini configuration file"
fi

# Ensure styles directory exists and sync packages if needed
if [ ! -d ".vale/styles" ]; then
    echo "ðŸ“ Creating .vale/styles directory..."
    mkdir -p .vale/styles
fi

# Check if styles need to be synced
if [ -f ".vale.ini" ] && [ ! -f ".vale/styles/.packages" ]; then
    echo "ðŸ“¦ Syncing Vale packages (first time setup)..."
    if vale sync; then
        echo "âœ… Vale packages synced successfully"
    else
        echo "âš ï¸  Failed to sync Vale packages, continuing with basic rules only"
    fi
fi

echo "ðŸ” Running Vale on prose files..."

# Get list of tracked prose files
FILES=$(git ls-files --cached --exclude-standard | grep -E '\.(md|txt|rst|adoc|asciidoc)$')

if [ -z "$FILES" ]; then
    echo "ðŸ“­ No prose files found to lint."
    exit 0
fi

# Count files for progress
TOTAL_FILES=$(echo "$FILES" | wc -l | tr -d ' ')
echo "ðŸ“ Found $TOTAL_FILES prose files to check"

# Run Vale with options:
# --no-exit: don't exit with error code on warnings
# --output=line: use line-based output format for better readability
# --sort: sort output by filename
if vale --output=line --sort $FILES; then
    echo "âœ¨ Vale prose linting completed successfully!"
    exit 0
else
    echo "âŒ Vale found prose issues. Please review and fix the issues above."
    echo "ðŸ’¡ Tips:"
    echo "   - Add custom rules to .vale.ini"
    echo "   - Use <!-- vale off --> and <!-- vale on --> to disable checks in sections"
    echo "   - Install additional style packages with 'vale sync'"
    exit 1
fi